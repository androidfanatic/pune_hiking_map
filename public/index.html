<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Hiker's Map</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id='map'></div>
  </div>
</body>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script>
  new Vue({
    el: '#app',
    data: function () {
      return { map: null, }
    },
    methods: {
      getPlaces() {
        fetch('/places').then(res => res.json()).then(places => {
          places.forEach(place => {

            const marker = new mapboxgl.Marker();
            const popup = new mapboxgl.Popup({
              offset: 25,
            });
            popup.setHTML(
              '<pre>' + JSON.stringify(place, null, 4) + '</pre>'
            );

            marker.setLngLat([place.lng, place.lat]);
            marker.setPopup(popup);

            marker.addTo(this.map);
          });
        })
      },
    },
    mounted() {
      fetch('/token').then(res => res.json()).then(json => {
        mapboxgl.accessToken = json.token;
        this.map = new mapboxgl.Map({
          container: 'map',
          zoom: 14,
          center: [73.8567, 18.5204],
          style: 'mapbox://styles/mapbox/dark-v9',
          hash: true,
          pitch: 60,
        });
        this.getPlaces();
      }).catch(() => {
        this.$notify.error({ title: 'Error', message: 'Unable to get token.' });
      })
    }
  })
</script>

</html>